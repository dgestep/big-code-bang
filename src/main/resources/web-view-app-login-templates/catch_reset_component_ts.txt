import {Component, OnInit} from "@angular/core";
import {ActivatedRoute, Params} from "@angular/router";
import {UserService} from "../shared/user.service";
import { ResponseMessageHelper } from "../shared/response.message.helper";
import { ResponseMessage } from "../shared/response.message";
import { ALERT_DANGER, ALERT_SUCC } from "../shared/constants";

@Component({
    selector: 'catch-reset',
    templateUrl: 'app/login/catch.reset.component.html'
})
export class CatchResetComponent implements OnInit{

    constructor(private activatedRoute : ActivatedRoute, private userService : UserService, private msgHelper : ResponseMessageHelper) {}

    ngOnInit() {
        this.activatedRoute.queryParams.subscribe((params: Params) => {
            let email = params["email"];
            let lookupKey = params["lookupkey"];

            if (email != null && lookupKey != null) {
                this.resetPassword(email, lookupKey)
            }
        });
    }

    private resetPassword(email : string, lookupkey : string) {
        let container : any = new FormData();
        let messages: Array<ResponseMessage> = [];

        container.append("emailAddress", email);
        container.append("resetUuid", lookupkey);
        this.userService.resetPasswordByConfirm(container).subscribe((res) => {
            if (res[0].message === "Success.") {
                messages.push(new ResponseMessage("Password successfully reset!  An email has been sent with your new password.", ALERT_SUCC));
                this.msgHelper.setMessages(messages);
            }
            else {
                while (messages.length != 0) {
                    messages.pop();
                }
                for (let i = 0; i < res.length; i++) {
                    messages.push(new ResponseMessage(res[i].message, ALERT_DANGER));
                }
                this.msgHelper.setMessages(messages);
            }
        });
    }
}