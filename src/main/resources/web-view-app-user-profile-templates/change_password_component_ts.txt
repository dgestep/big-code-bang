import {Component, OnInit} from "@angular/core";
import {SessionHelper} from "../shared/session.helper";
import {UserService} from "../shared/user.service";
import { ResponseMessageHelper } from "../shared/response.message.helper";
import { ResponseMessage } from "../shared/response.message";
import {FormGroup, FormBuilder} from "@angular/forms";
import { ALERT_DANGER, ALERT_SUCC } from "../shared/constants";
import {TabManagerService} from "../tabs/tab.manager.service";

@Component({
    selector: 'change-password',
    templateUrl: 'app/user-profile/change.password.component.html'
})
export class ChangePasswordComponent implements OnInit {
    passwordForm : FormGroup;

    constructor(private userService : UserService, private msgHelper : ResponseMessageHelper,
                private sessionHelper: SessionHelper, private formBuilder : FormBuilder,
                private tabService : TabManagerService) {
        this.msgHelper.clearMessages();
    }

    ngOnInit() {
        this.passwordForm = this.formBuilder.group({
            currentPassword : [''],
            newPassword  : [''],
            confirmPassword : [''],
        });
    }

    private submitChange() {
        let messages: Array<ResponseMessage> = [];
        let userObj: any = new FormData();

        if (this.passwordForm.value.newPassword !== this.passwordForm.value.confirmPassword) {
            messages.push(new ResponseMessage("Passwords do not match.  Please try again.", ALERT_DANGER));
            this.msgHelper.setMessages(messages);
        }
        else {
            userObj.append("emailAddress", this.sessionHelper.getEmailAddress());
            userObj.append("currentPassword", this.passwordForm.value.currentPassword);
            userObj.append("newPassword", this.passwordForm.value.newPassword);

            this.userService.changeUserPassword(userObj).subscribe((res) => {
                if (res[0].message === "Success.") {
                    messages.push(new ResponseMessage("Password change successful!", ALERT_SUCC));
                    this.msgHelper.setMessages(messages);
                    this.closeTab();
                }
                else {
                    while (messages.length != 0) {
                        messages.pop();
                    }
                    for (let i = 0; i < res.length; i++) {
                        messages.push(new ResponseMessage(res[i].message, ALERT_DANGER));
                    }
                    this.msgHelper.setMessages(messages);
                }
            });
        }
    }

    closeTab() {
        this.tabService.deleteTab(this.tabService.getTabIndex('Change Password', 'change-password'));
    }

}